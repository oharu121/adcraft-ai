# Dev Notes - 2025-11-13

## GCP Cost Management & Resource Control

### Infrastructure Overview

**Current Deployment Stack:**
- **Project**: `adcraft-dev-2025`
- **Region**: `asia-northeast1`
- **Cloud Run Service**: `adcraft-service`
- **Infrastructure Tool**: Pulumi
- **Container Registry**: Artifact Registry (`adcraft-ai`)

**Managed Resources:**
```
infrastructure/
â”œâ”€â”€ index.ts          # Main infrastructure orchestration
â”œâ”€â”€ compute.ts        # Cloud Run service configuration
â”œâ”€â”€ storage.ts        # Cloud Storage buckets
â”œâ”€â”€ database.ts       # Firestore database
â”œâ”€â”€ iam.ts           # Service accounts & permissions
â””â”€â”€ monitoring.ts    # Budget alerts & monitoring
```

---

## GCP Costable Resources Breakdown

### 1. **Cloud Run (Compute)**
**Location**: [infrastructure/compute.ts](../infrastructure/compute.ts)

**Current Configuration:**
- **Min Scale**: 0 (scales to zero when idle)
- **Max Scale**: 10 instances
- **CPU**: 2 vCPU (limit), 1 vCPU (request)
- **Memory**: 2Gi (limit), 512Mi (request)
- **Timeout**: 300s (5 minutes)

**Charging Model:**
- Billed per 100ms of CPU time
- Billed per GB-second of memory
- **No charges when scaled to 0**

**Cost Control Commands:**
```bash
# Stop all instances immediately
gcloud run services update adcraft-service \
  --region=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --min-instances=0 \
  --max-instances=0

# Remove traffic (scales to 0)
gcloud run services update adcraft-service \
  --region=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --no-traffic

# Delete service completely
gcloud run services delete adcraft-service \
  --region=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --quiet
```

---

### 2. **Artifact Registry (Container Storage)**
**Current Setup:**
- **Repository**: `adcraft-ai`
- **Format**: Docker
- **Image Path**: `asia-northeast1-docker.pkg.dev/adcraft-dev-2025/adcraft-ai/adcraft-ai:latest`

**Charging Model:**
- Storage per GB per month
- Charges continue even if service is stopped

**Cost Control Commands:**
```bash
# List all images
gcloud artifacts docker images list \
  asia-northeast1-docker.pkg.dev/adcraft-dev-2025/adcraft-ai

# Delete specific image
gcloud artifacts docker images delete \
  asia-northeast1-docker.pkg.dev/adcraft-dev-2025/adcraft-ai/adcraft-ai:latest \
  --quiet

# Delete entire repository (removes all images)
gcloud artifacts repositories delete adcraft-ai \
  --location=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --quiet
```

---

### 3. **Cloud Storage (Buckets)**
**Purpose**: User uploads, generated assets, temp files

**Charging Model:**
- Storage per GB per month
- Network egress charges
- Operations charges (uploads/downloads)

**Cost Control Commands:**
```bash
# List all buckets
gsutil ls -p adcraft-dev-2025

# Check bucket size
gsutil du -s gs://YOUR_BUCKET_NAME

# Delete specific files
gsutil rm gs://YOUR_BUCKET_NAME/path/to/file

# Delete entire bucket
gsutil rm -r gs://YOUR_BUCKET_NAME
```

---

### 4. **Firestore (Database)**
**Purpose**: Session data, user data, analytics

**Charging Model:**
- Document reads/writes
- Storage per GB
- Network egress

**Cost Control Commands:**
```bash
# View Firestore usage (via Console)
# https://console.cloud.google.com/firestore/usage?project=adcraft-dev-2025

# Delete collections programmatically
# (requires custom script - Firestore doesn't have bulk delete CLI)
```

---

### 5. **Networking & Data Transfer**
**Charging Model:**
- Egress traffic (data leaving GCP)
- Inter-region traffic
- Load balancing

**Cost Control:**
- Minimize external API calls
- Use CDN for static assets
- Keep services in same region

---

## Complete Shutdown Strategies

### **Option 1: Temporary Stop (Keep Infrastructure)**
```bash
# Stop Cloud Run instances
gcloud run services update adcraft-service \
  --region=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --min-instances=0 \
  --max-instances=0

# Note: Storage and Artifact Registry still incur charges
```

**What Stops Charging:**
- Cloud Run CPU/Memory

**What Keeps Charging:**
- Artifact Registry storage
- Cloud Storage
- Firestore storage

---

### **Option 2: Delete Cloud Run Only**
```bash
gcloud run services delete adcraft-service \
  --region=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --quiet
```

**What Stops Charging:**
- Cloud Run service

**What Keeps Charging:**
- Docker images in Artifact Registry
- Cloud Storage buckets
- Firestore data

---

### **Option 3: Full Infrastructure Teardown (Pulumi)**
```bash
cd infrastructure
pulumi destroy --yes
```

**What Gets Deleted:**
- Cloud Run service
- Artifact Registry repository
- Storage buckets (if configured)
- Firestore database (if configured)
- IAM service accounts
- Monitoring resources

**Warning**: Check Pulumi resource configs for data retention policies!

---

### **Option 4: Selective Cleanup (Recommended)**
```bash
# 1. Stop Cloud Run
gcloud run services delete adcraft-service \
  --region=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --quiet

# 2. Delete Docker images
gcloud artifacts repositories delete adcraft-ai \
  --location=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --quiet

# 3. Clean up old files in storage (keep bucket structure)
gsutil -m rm -r gs://YOUR_BUCKET_NAME/uploads/*
gsutil -m rm -r gs://YOUR_BUCKET_NAME/generated/*

# 4. Keep Firestore for session history (minimal cost)
```

---

## Cost Monitoring Commands

### **Check Current Resources**
```bash
# List all Cloud Run services
gcloud run services list --project=adcraft-dev-2025

# List all Artifact Registry repos
gcloud artifacts repositories list --project=adcraft-dev-2025

# List all storage buckets
gcloud storage buckets list --project=adcraft-dev-2025

# Check active Cloud Run revisions
gcloud run revisions list \
  --service=adcraft-service \
  --region=asia-northeast1 \
  --project=adcraft-dev-2025
```

### **Check Billing**
```bash
# List billing accounts
gcloud billing accounts list

# Get project billing info
gcloud billing projects describe adcraft-dev-2025

# View budget alerts (via Console)
# https://console.cloud.google.com/billing/budgets?project=adcraft-dev-2025
```

---

## Quick Reference: Package.json Scripts

From [package.json](../package.json):

```json
{
  "docker:build": "docker build -t adcraft-ai .",
  "docker:tag": "docker tag adcraft-ai asia-northeast1-docker.pkg.dev/adcraft-dev-2025/adcraft-ai/adcraft-ai:latest",
  "docker:push": "docker push asia-northeast1-docker.pkg.dev/adcraft-dev-2025/adcraft-ai/adcraft-ai:latest",
  "docker:deploy": "npm run docker:build && npm run docker:tag && npm run docker:push",
  "gcloud:url": "gcloud run services describe adcraft-service --region=asia-northeast1 --project=adcraft-dev-2025 --format=\"value(status.url)\""
}
```

**Usage:**
```bash
# Build and push new image
npm run docker:deploy

# Get current service URL
npm run gcloud:url
```

---

## Best Practices for Cost Control

### **1. Development Strategy**
- Use `APP_MODE=demo` for local development (no GCP costs)
- Test locally before deploying to Cloud Run
- Use `minScale: 0` to allow scaling to zero when idle

### **2. Production Monitoring**
- Set up budget alerts (configured in `monitoring.ts`)
- Review costs weekly via GCP Console
- Monitor at 50%, 75%, 90% of budget

### **3. Resource Cleanup**
- Delete old container images regularly
- Clean up temp files in Cloud Storage
- Archive old Firestore data
- Review and delete unused Cloud Run revisions

### **4. Emergency Shutdown**
```bash
# One-liner to stop all compute immediately
gcloud run services delete adcraft-service \
  --region=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --quiet && \
gcloud artifacts repositories delete adcraft-ai \
  --location=asia-northeast1 \
  --project=adcraft-dev-2025 \
  --quiet
```

---

## Key Insights

### **Infrastructure Design**
- **Pulumi manages**: Compute, Storage, Database, IAM, Monitoring
- **Manual deployment**: Docker images via `npm run docker:deploy`
- **Scaling**: Configured for 0-10 instances (can scale to zero)

### **Cost Optimization**
- **Biggest cost**: Cloud Run when running (CPU + Memory)
- **Ongoing costs**: Artifact Registry storage, Cloud Storage
- **Minimal costs**: Firestore (if low usage), Monitoring
- **Free tier**: Some GCP services have free quotas

### **Safety Notes**
- `pulumi destroy` is irreversible - backup data first
- Deleting storage buckets removes all data permanently
- Service accounts are tied to Pulumi - deleting breaks access
- Check data retention policies before destroying databases

---

## Decision Matrix

| Scenario | Recommended Action | Charges Stopped |
|----------|-------------------|-----------------|
| **Pause for a day** | `--min-instances=0 --max-instances=0` | Cloud Run only |
| **Pause for a week** | Delete Cloud Run service | Cloud Run only |
| **Pause for a month** | Delete Cloud Run + Artifact Registry | Compute + Images |
| **Project completed** | `pulumi destroy` | Everything |
| **Emergency stop** | Delete Cloud Run immediately | Compute only |

---

## References

- **GCP Console**: https://console.cloud.google.com/run?project=adcraft-dev-2025
- **Pulumi Docs**: https://www.pulumi.com/docs/
- **Cloud Run Pricing**: https://cloud.google.com/run/pricing
- **Artifact Registry Pricing**: https://cloud.google.com/artifact-registry/pricing

---

## Action Items

- [ ] Review current GCP billing dashboard
- [ ] Set up budget alerts if not already configured
- [ ] Document current monthly costs baseline
- [ ] Create backup strategy for important data
- [ ] Test `pulumi destroy` in a safe environment first

---

## Current Charges Report (2025-11-13)

### Active Resources Audit

#### 1. Cloud Run Service - ACTIVELY CHARGING
**Service**: `adcraft-service`
- **URL**: https://adcraft-service-ybvh3xrona-an.a.run.app
- **Status**: RUNNING (100% traffic to latest revision)
- **Resources**: 2 vCPU, 2Gi memory
- **Region**: asia-northeast1
- **Created**: 2025-08-27
- **Latest Revision**: adcraft-service-00007-fpt
- **Cost**: Variable based on requests and compute time
  - Charged per 100ms of CPU time
  - Charged per GB-second of memory
  - **NOTE**: Configured with minScale: 0 but currently receiving traffic

#### 2. Artifact Registry - STORAGE CHARGES
**Total Storage**: ~275 MB across 3 repositories

| Repository | Format | Storage | Monthly Cost Estimate |
|-----------|--------|---------|---------------------|
| `adcraft-ai` | Docker | 183 MB | ~$0.018/month |
| `gcr.io` | Docker | 92 MB | ~$0.009/month |
| `cloud-run-source-deploy` | Docker | 0 MB | $0 |
| **TOTAL** | | **275 MB** | **~$0.027/month** |

**Image Count in adcraft-ai**: 7 Docker images (multiple versions from Oct 30-31, 2025)
- Most recent: sha256:019e1f3f... (2025-10-30)
- Oldest tracked: sha256:e4bee3ba... (2025-09-22)

**Cost Calculation**: $0.10/GB/month Ã— 0.275 GB = $0.027/month

#### 3. Cloud Storage Buckets - STORAGE CHARGES

| Bucket Name | Region | Purpose | Status |
|------------|--------|---------|--------|
| `adcraft-storage-dev` | asia-northeast1 | Main storage + logs | Active |
| `adcraft-dev-2025_cloudbuild` | US | Cloud Build artifacts | Active |
| `run-sources-adcraft-dev-2025-asia-northeast1` | asia-northeast1 | Cloud Run sources | Active |

**Storage Contents (adcraft-storage-dev)**:
- Cloud Audit logs (cloudaudit.googleapis.com/activity, system_event)
- Cloud Run request logs (run.googleapis.com/requests)
- Cloud Run error logs (run.googleapis.com/stderr)
- Date range: 2025-10-30 to 2025-11-08 (accumulating)
- **Cost**: Estimated $0.02-0.05/month (based on log volume)

#### 4. Firestore Database - FREE TIER
**Database**: `(default)`
- **Type**: FIRESTORE_NATIVE
- **Region**: asia-northeast1
- **Created**: 2025-08-27
- **Free Tier**: YES (no charges while within limits)
- **Point-in-Time Recovery**: Disabled
- **Delete Protection**: Disabled
- **Realtime Updates**: Enabled

**Collections Used by App**:
- `sessions` - Video generation sessions
- `videoJobs` - Video processing jobs
- `productAnalyses` - Product intelligence data
- `costs` - Cost tracking
- `agentHandoffs` - Agent-to-agent data transfer

**Charging Model**:
- Free tier: 50K reads, 20K writes, 20K deletes per day
- Storage: 1 GB free
- **Current Status**: On free tier (no charges unless limits exceeded)
- **Cost if exceeded**: $0.06/100K reads, $0.18/100K writes

**Cost Estimate**: $0/month (free tier active)

---

### Cost Summary

| Resource Type | Status | Monthly Estimate |
|--------------|--------|-----------------|
| Cloud Run (Compute) | ACTIVE | Variable (depends on traffic) |
| Artifact Registry | ACTIVE | $0.027/month |
| Cloud Storage | ACTIVE | $0.02-0.05/month |
| Firestore | ACTIVE (FREE TIER) | $0/month (within free limits) |
| **Baseline Monthly Cost** | | **~$0.05-0.08/month** |

**NOTE**: Cloud Run charges are **variable** and depend on:
- Number of requests received
- CPU time per request
- Memory usage
- If service is receiving traffic, charges will be significantly higher than baseline

---

### Recommended Actions to Stop Charges

#### Option A: Complete Shutdown (Recommended)
**Actions**:
1. Delete Cloud Run service â†’ **Stops compute charges immediately**
2. Delete Artifact Registry repositories â†’ **Saves $0.027/month**
3. Keep storage buckets (logs are useful for audit)

**Result**: ~$0.02/month (logs only)

#### Option B: Temporary Pause
**Actions**:
1. Scale Cloud Run to min=0, max=0 â†’ **Stops compute when no traffic**
2. Keep all infrastructure intact

**Result**: $0.05-0.08/month baseline

#### Option C: Nuclear Option (Pulumi Destroy)
**Actions**:
1. Run `pulumi destroy` in infrastructure folder
2. Deletes: Cloud Run, Artifact Registry, Storage, IAM, Monitoring

**Result**: $0/month (everything deleted)

---

### Service URLs for Reference
- **Cloud Run**: https://adcraft-service-ybvh3xrona-an.a.run.app
- **GCP Console**: https://console.cloud.google.com/run?project=adcraft-dev-2025
- **Billing Dashboard**: https://console.cloud.google.com/billing?project=adcraft-dev-2025

---

---

## Actual Billing History

### Last Month (October 2025): Â¥7,000 (~$45-47 USD)

**Primary Cost Driver**: Cloud Run compute (actively serving traffic)

**Why $45/month vs $0.05 baseline?**
- **Baseline cost** ($0.05-0.08) = Storage + Registry only (no compute)
- **Actual cost** ($45-47) = **Cloud Run is actively running and serving requests**

**Cost breakdown estimate:**
- Cloud Run compute: ~$44-46/month (variable, traffic-dependent)
- Artifact Registry: $0.027/month (fixed)
- Cloud Storage: $0.02-0.05/month (fixed)
- Firestore: $0/month (free tier)

**Analysis**: You are **NOT overcharged**. The service is:
- Publicly accessible at https://adcraft-service-ybvh3xrona-an.a.run.app
- Receiving traffic (user requests, bots, health checks, monitoring)
- Configured with 2 vCPU + 2Gi memory (expensive resources)
- Scaling up to handle requests (each instance incurs charges)

**Why traffic exists:**
1. Public URL is discoverable by bots/crawlers
2. GCP health checks to keep service ready
3. Actual user/developer access
4. Cold starts keeping instances warm

**To stop $45/month charges**: Must delete or stop Cloud Run service

---

---

## Infrastructure Destruction Report (2025-11-13)

### Execution: Option C - Complete Infrastructure Teardown

**Executed**: 2025-11-13 14:30-14:45 JST
**Method**: Manual gcloud commands (Pulumi destroy failed due to credentials)

### Resources Deleted:

#### 1. Cloud Run Service âœ… DELETED
- **Service**: `adcraft-service`
- **URL**: https://adcraft-service-ybvh3xrona-an.a.run.app (now inactive)
- **Impact**: **~$45/month savings** (primary cost driver eliminated)
- **Command**: `gcloud run services delete adcraft-service`
- **Status**: Successfully deleted

#### 2. Artifact Registry âœ… DELETED
- **Repository**: `adcraft-ai` (183 MB) - DELETED
- **Repository**: `cloud-run-source-deploy` (0 MB) - DELETED
- **Impact**: **$0.018/month savings**
- **Status**: Successfully deleted

#### 3. Container Registry (gcr.io) âœ… CLEANED
- **Images Deleted**:
  - `gcr.io/adcraft-dev-2025/adcraft-ai` (2 untagged images)
  - `gcr.io/adcraft-dev-2025/adcraft-service` (2 untagged images)
- **Repository**: gcr.io (empty, kept as placeholder)
- **Impact**: **$0.009/month savings**
- **Status**: All images deleted, repository empty

#### 4. Storage Buckets âœ… KEPT (as planned)
- `adcraft-storage-dev` - ACTIVE (logs)
- `adcraft-dev-2025_cloudbuild` - ACTIVE
- `run-sources-adcraft-dev-2025-asia-northeast1` - ACTIVE
- **Impact**: Minimal cost (~$0.02-0.05/month for logs)
- **Reason**: Kept for audit trail and historical logs

#### 5. Firestore âœ… KEPT (free tier)
- **Database**: `(default)` - ACTIVE
- **Impact**: $0/month (free tier)
- **Reason**: No cost, useful for historical data

### Cost Impact Summary

| Period | Cost | Status |
|--------|------|--------|
| **Before (October 2025)** | Â¥7,000/month (~$45-47 USD) | Active Cloud Run |
| **After (November 2025)** | **~$0.02-0.05/month** | Storage logs only |
| **Monthly Savings** | **~$45/month (Â¥7,000)** | **97% reduction** |
| **Annual Savings** | **~$540/year (Â¥84,000)** | |

### Remaining Resources (Minimal Cost)

| Resource | Status | Monthly Cost |
|----------|--------|-------------|
| Cloud Storage (logs) | ACTIVE | $0.02-0.05 |
| Firestore (free tier) | ACTIVE | $0.00 |
| gcr.io placeholder | EMPTY | $0.00 |
| **TOTAL** | | **~$0.02-0.05** |

### Verification Commands

```bash
# Verify Cloud Run deleted
gcloud run services list --project=adcraft-dev-2025
# Result: Listed 0 items âœ…

# Verify Artifact Registry cleaned
gcloud artifacts repositories list --project=adcraft-dev-2025
# Result: Only gcr.io placeholder remains (empty) âœ…

# Verify Container images deleted
gcloud container images list --repository=gcr.io/adcraft-dev-2025
# Result: Listed 0 items âœ…
```

### What Was NOT Deleted

These resources were intentionally kept:
1. **GCP Project** (`adcraft-dev-2025`) - Still active
2. **Storage buckets** - Contains audit logs and historical data
3. **Firestore database** - Free tier, contains session history
4. **IAM service accounts** - May still exist (minimal/no cost)
5. **Monitoring resources** - May still exist (minimal/no cost)

### Re-deployment Instructions

If you need to restore the service:

```bash
# 1. Navigate to infrastructure folder
cd f:\repository\adcraft-ai\infrastructure

# 2. Authenticate Pulumi
gcloud auth application-default login

# 3. Rebuild infrastructure
pulumi up

# 4. Build and deploy Docker image
cd ..
npm run docker:build
npm run docker:tag
npm run docker:push
```

---

---

## Final Storage Bucket Deletion (2025-11-13)

### Additional Resources Deleted:

#### 6. Storage Buckets âœ… ALL DELETED
- **Bucket**: `adcraft-storage-dev` - DELETED
  - Contained: Cloud Audit logs, Cloud Run logs (Oct 30 - Nov 8, 2025)
  - Status: Successfully deleted with all contents
- **Bucket**: `adcraft-dev-2025_cloudbuild` - DELETED
  - Contained: Cloud Build source archives
  - Status: Successfully deleted with all contents
- **Bucket**: `run-sources-adcraft-dev-2025-asia-northeast1` - DELETED
  - Contained: Cloud Run source deployments
  - Status: Successfully deleted with all contents

**Impact**: Additional **$0.02-0.05/month savings**

### Final Cost Impact Summary

| Period | Cost | Savings |
|--------|------|---------|
| **Before (October 2025)** | Â¥7,000/month (~$45-47 USD) | - |
| **After Storage Deletion** | **$0.00/month** | **100% reduction** |
| **Monthly Savings** | **~$45/month (Â¥7,000)** | |
| **Annual Savings** | **~$540/year (Â¥84,000)** | |

### Final Remaining Resources (ZERO COST)

| Resource | Status | Monthly Cost |
|----------|--------|-------------|
| Cloud Run | DELETED | $0.00 |
| Artifact Registry | DELETED | $0.00 |
| Container Registry | EMPTY | $0.00 |
| Cloud Storage | ALL DELETED | $0.00 |
| Firestore (free tier) | ACTIVE | $0.00 |
| **TOTAL** | | **$0.00** |

### Final Verification

```bash
# Storage Buckets
gcloud storage buckets list --project=adcraft-dev-2025
# Result: Listed 0 items âœ…

# Cloud Run
gcloud run services list --project=adcraft-dev-2025
# Result: Listed 0 items âœ…

# Artifact Registry (only empty gcr.io placeholder)
gcloud artifacts repositories list --project=adcraft-dev-2025
# Result: gcr.io (empty, 0 images) âœ…
```

### What Remains

**Only these resources exist:**
1. **GCP Project** (`adcraft-dev-2025`) - Active, no charges
2. **Firestore database** - Active, FREE TIER (no charges)
3. **gcr.io placeholder** - Empty repository (no charges)
4. **Billing account link** - Active (for historical tracking)

**Monthly cost: $0.00** ðŸŽ‰

---

**Last Updated**: 2025-11-13 15:00 JST (Complete Infrastructure Destruction + Storage Deletion)
**Status**: âœ… **ALL INFRASTRUCTURE DELETED - ZERO MONTHLY CHARGES ($0.00/month)**
